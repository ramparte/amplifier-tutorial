# Scan Ecosystem Recipe
# Discovers all Amplifier ecosystem components and updates the manifest
#
# Usage:
#   amplifier recipes execute recipes/scan-ecosystem.yaml
#
# Output:
#   Updates .planning/ecosystem-manifest.yaml with discovered components

name: scan-ecosystem
description: Discover all components across the Amplifier ecosystem
version: "1.0.0"
author: "Tutorial Team"
tags: ["scanning", "ecosystem", "discovery"]

context:
  manifest_path: ".planning/ecosystem-manifest.yaml"
  modules_url: "https://raw.githubusercontent.com/microsoft/amplifier/main/docs/MODULES.md"
  core_repos:
    - "microsoft/amplifier"
    - "microsoft/amplifier-core"
    - "microsoft/amplifier-foundation"
  community_users:
    - "robotdad"
    - "bkrabach"

recursion:
  max_depth: 3
  max_total_steps: 30

steps:
  # Step 1: Fetch the official MODULES.md catalog
  - id: fetch-modules-catalog
    agent: foundation:web-research
    prompt: |
      Fetch the official Amplifier modules catalog from:
      {{modules_url}}
      
      Extract ALL components mentioned, organized by type.
      
      Return this JSON structure:
      {
        "fetched": true,
        "source": "{{modules_url}}",
        "core": [{"id": "...", "name": "...", "repo": "...", "type": "...", "description": "..."}],
        "bundles": [...],
        "providers": [...],
        "tools": [...],
        "orchestrators": [...],
        "context": [...],
        "hooks": [...],
        "applications": [...]
      }
      
      For each component include:
      - id: kebab-case identifier
      - name: display name
      - repo: org/repo-name
      - type: bundle, provider, tool, etc.
      - description: brief description
      
      Return ONLY the JSON.
    output: "official_catalog"
    parse_json: true
    timeout: 300
    retry:
      max_attempts: 3
      backoff: "exponential"
      initial_delay: 10
    on_error: "fail"

  # Step 2: Scan core repos for detailed info
  - id: scan-core-repos
    foreach: "{{core_repos}}"
    as: "repo"
    parallel: true
    agent: foundation:explorer
    prompt: |
      Scan GitHub repository: {{repo}}
      
      Extract:
      1. All markdown documentation files (paths)
      2. Module definitions (from bundle.md, behavior files, etc.)
      3. Version information (from pyproject.toml or package.json)
      4. Key capabilities and features
      
      Return JSON:
      {
        "repo": "{{repo}}",
        "docs": ["path/to/doc.md", ...],
        "modules": [{"name": "...", "type": "...", "path": "..."}],
        "version": "x.y.z or unknown",
        "description": "repo description"
      }
      
      Return ONLY the JSON.
    output: "repo_result"
    collect: "core_repo_scans"
    parse_json: true
    timeout: 300
    retry:
      max_attempts: 2
      backoff: "exponential"
      initial_delay: 10
    on_error: "continue"

  # Step 3: Scan community contributor repos
  - id: scan-community-repos
    foreach: "{{community_users}}"
    as: "user"
    parallel: true
    agent: foundation:web-research
    prompt: |
      Search GitHub user "{{user}}" for Amplifier-related repositories.
      
      Look for repos that:
      - Have "amplifier" in the name
      - Are bundles, modules, collections, or skills
      - Contain tools useful for Amplifier development
      
      Return JSON:
      {
        "user": "{{user}}",
        "repos": [
          {
            "id": "kebab-case-id",
            "name": "Display Name",
            "repo": "{{user}}/repo-name",
            "type": "bundle/skill/dev-tool/collection",
            "description": "brief description",
            "install_command": "install cmd if known"
          }
        ]
      }
      
      Return ONLY the JSON.
    output: "user_result"
    collect: "community_scans"
    parse_json: true
    timeout: 300
    retry:
      max_attempts: 2
      backoff: "exponential"
      initial_delay: 10
    on_error: "continue"

  # Step 4: Merge into unified manifest
  - id: merge-findings
    agent: foundation:zen-architect
    mode: "ARCHITECT"
    prompt: |
      Merge all scan results into a unified ecosystem manifest.
      
      Official catalog:
      {{official_catalog}}
      
      Core repo scans:
      {{core_repo_scans}}
      
      Community contributions:
      {{community_scans}}
      
      Create a YAML manifest with these sections:
      - meta (version: "1.0.0", last_scan: ISO timestamp, sources: list of URLs)
      - core (amplifier, amplifier-core, amplifier-foundation)
      - bundles (official and community)
      - providers
      - tools
      - orchestrators
      - context
      - hooks
      - skills
      - collections
      - dev_tools
      - applications
      - example_recipes (from recipes bundle)
      - foundation_examples (from foundation)
      
      For each component include:
      - id: kebab-case identifier
      - name: display name
      - repo: org/repo-name (full path)
      - type: component type
      - description: brief description
      - owner: username (for community components)
      - priority: 1=core, 2=recommended, 3=optional
      
      Return valid YAML (not JSON) that can be written directly to file.
    output: "merged_manifest"
    timeout: 600
    retry:
      max_attempts: 2
      backoff: "exponential"
      initial_delay: 10
    on_error: "fail"

  # Step 5: Read existing manifest for comparison
  - id: read-existing-manifest
    agent: foundation:file-ops
    prompt: |
      Read the file at {{manifest_path}} if it exists.
      
      Return the full contents of the file.
      
      If file doesn't exist, return: "FILE_NOT_FOUND"
    output: "existing_manifest"
    timeout: 60
    on_error: "continue"

  # Step 6: Compare manifests and report changes
  - id: compare-manifests
    agent: foundation:zen-architect
    mode: "ANALYZE"
    prompt: |
      Compare the existing manifest with the new one.
      
      Existing manifest:
      {{existing_manifest}}
      
      New manifest:
      {{merged_manifest}}
      
      Analyze and return JSON:
      {
        "is_initial_scan": true/false,
        "new_components": [{"id": "...", "type": "...", "name": "..."}],
        "removed_components": [{"id": "...", "type": "...", "name": "..."}],
        "updated_components": [{"id": "...", "changes": "..."}],
        "summary": "Human-readable summary of changes"
      }
      
      If existing manifest was "FILE_NOT_FOUND", set is_initial_scan to true.
      Return ONLY the JSON.
    output: "change_report"
    parse_json: true
    timeout: 300
    on_error: "continue"

  # Step 7: Write updated manifest
  - id: write-manifest
    agent: foundation:file-ops
    prompt: |
      Write the merged manifest to {{manifest_path}}.
      
      First, add a header comment at the top:
      ```
      # Amplifier Ecosystem Manifest
      # Generated: [current ISO timestamp]
      # Purpose: Structured inventory of all ecosystem components for tutorial generation
      #
      # Changes from previous scan:
      # {{change_report.summary}}
      ```
      
      Then write the manifest content:
      {{merged_manifest}}
      
      Ensure the directory exists and write the file.
      Return confirmation of what was written.
    output: "write_result"
    timeout: 60
    retry:
      max_attempts: 2
      backoff: "exponential"
      initial_delay: 5
    on_error: "fail"

  # Step 8: Generate summary report
  - id: summary
    agent: foundation:zen-architect
    mode: "ANALYZE"
    prompt: |
      Create a human-readable summary of the ecosystem scan.
      
      Change report:
      {{change_report}}
      
      Write result:
      {{write_result}}
      
      Include:
      - Total components discovered by type
      - New additions since last scan
      - Any components removed
      - Recommendations for tutorial content that needs updating
      
      Format as markdown suitable for display to the user.
    output: "final_summary"
    timeout: 120
    on_error: "continue"
