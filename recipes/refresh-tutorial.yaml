# Refresh Tutorial Recipe
# Updates all tutorial content by checking for stale content and regenerating
#
# Usage:
#   amplifier recipes execute recipes/refresh-tutorial.yaml
#   amplifier recipes execute recipes/refresh-tutorial.yaml --context '{"force": true}'
#
# This recipe:
# 1. Scans the ecosystem for any changes
# 2. Identifies stale content (older than source)
# 3. Regenerates content using research-component recipe
# 4. Updates indices and navigation

name: refresh-tutorial
description: Update all tutorial content from source repositories

context:
  manifest_path: ".planning/ecosystem-manifest.yaml"
  content_base: "content"
  force: false  # If true, regenerate all content regardless of age
  parallel_limit: 3  # How many components to process in parallel

steps:
  # Step 1: Run ecosystem scan first
  - id: scan-ecosystem
    recipe: ./scan-ecosystem.yaml
    description: "Scan for new or changed components"

  # Step 2: Load updated manifest
  - id: load-manifest
    agent: foundation:file-ops
    instruction: |
      Read the ecosystem manifest at {{manifest_path}}.
      
      Extract all components that should have tutorial content:
      - All items from: bundles, providers, tools, hooks, skills, dev_tools
      - Filter to priority 1 and 2 items (skip priority 3 unless force=true)
      
      For each component, return:
      - id
      - type (which section it's in)
      - repo
      - priority

  # Step 3: Check content freshness
  - id: check-freshness
    agent: foundation:file-ops
    instruction: |
      For each component in the manifest, check if content exists and its freshness.
      
      Components to check:
      {{load-manifest.result}}
      
      For each component:
      1. Check if {{content_base}}/[type]/[id].md exists
      2. If exists, read the frontmatter and get last_synced date
      3. Compare with repo's last commit date (or just note if file exists)
      
      Return a list categorized as:
      - missing: Components with no content file
      - stale: Components where content is older than 7 days
      - fresh: Components with recent content
      
      If force={{force}}, mark all existing content as stale.

  # Step 4: Generate content for missing/stale components
  - id: regenerate-content
    foreach: "{{check-freshness.result.missing + check-freshness.result.stale}}"
    parallel: "{{parallel_limit}}"
    recipe: ./research-component.yaml
    context:
      component_id: "{{item.id}}"
      component_type: "{{item.type}}"

  # Step 5: Regenerate all index files
  - id: regenerate-indices
    agent: foundation:file-ops
    instruction: |
      Regenerate the _index.yaml file for each content directory.
      
      For each directory in {{content_base}}/:
      - tools/
      - bundles/
      - skills/
      - concepts/
      - dev-setup/
      
      Read all .md files in the directory, extract frontmatter, and create:
      
      ```yaml
      # [Type] Index
      # Auto-generated by refresh-tutorial recipe
      
      components:
        - id: [from frontmatter]
          title: [from frontmatter]
          description: [first paragraph or frontmatter description]
          last_updated: [from frontmatter last_synced]
      ```
      
      Sort alphabetically by title.

  # Step 6: Update navigation
  - id: update-navigation
    agent: foundation:file-ops
    instruction: |
      Update the mkdocs.yml navigation to include all content.
      
      Read the current mkdocs.yml file.
      
      For each content section (Tools Reference, Bundles Reference, Skills Reference):
      - Read the corresponding _index.yaml
      - Add navigation entries for each component
      
      Example update for Tools Reference:
      ```yaml
      - Tools Reference:
        - Overview: tools/index.md
        - Filesystem: tools/tool-filesystem.md
        - Bash: tools/tool-bash.md
        # ... etc
      ```
      
      Write the updated mkdocs.yml.

  # Step 7: Generate summary report
  - id: summary-report
    agent: foundation:zen-architect
    instruction: |
      Create a refresh summary report.
      
      Ecosystem scan results:
      {{scan-ecosystem.result}}
      
      Content freshness check:
      {{check-freshness.result}}
      
      Regeneration results:
      {{regenerate-content.results}}
      
      Create a markdown report showing:
      
      ## Tutorial Refresh Summary
      
      ### Ecosystem Changes
      - New components discovered: [count]
      - Removed components: [count]
      
      ### Content Updates
      - Missing content generated: [count]
      - Stale content refreshed: [count]
      - Fresh content (unchanged): [count]
      
      ### Components Updated
      [List each updated component with status]
      
      ### Errors (if any)
      [List any failures]
      
      ### Next Steps
      - Human review recommended for: [list]
      - Build site with: mkdocs build
